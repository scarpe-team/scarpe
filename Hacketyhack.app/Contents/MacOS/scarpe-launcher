#!/bin/bash
# Scarpe App Launcher — generated by scarpe package
set -e

DIR="$(cd "$(dirname "$0")/../Resources"; pwd)"
RUBY_ROOT="$DIR/runtime/ruby"
GEMS_ROOT="$DIR/runtime/gems"

# Save original environment for restore
export ORIG_TERMINFO="$TERMINFO"
export ORIG_SSL_CERT_DIR="$SSL_CERT_DIR"
export ORIG_SSL_CERT_FILE="$SSL_CERT_FILE"
export ORIG_RUBYOPT="$RUBYOPT"
export ORIG_RUBYLIB="$RUBYLIB"

# Configure Traveling Ruby environment
export TERMINFO=/usr/share/terminfo
export SSL_CERT_FILE="$RUBY_ROOT/lib/ca-bundle.crt"
unset SSL_CERT_DIR

export RUBYOPT="-rtraveling_ruby_restore_environment"
export GEM_HOME="$GEMS_ROOT"
export GEM_PATH="$GEMS_ROOT:$RUBY_ROOT/lib/ruby/gems/3.4.0"
export RUBYLIB="$RUBY_ROOT/lib/ruby/site_ruby/3.4.0:$RUBY_ROOT/lib/ruby/site_ruby/3.4.0/x86_64-darwin22:$RUBY_ROOT/lib/ruby/site_ruby:$RUBY_ROOT/lib/ruby/vendor_ruby/3.4.0:$RUBY_ROOT/lib/ruby/vendor_ruby/3.4.0/x86_64-darwin22:$RUBY_ROOT/lib/ruby/vendor_ruby:$RUBY_ROOT/lib/ruby/3.4.0:$RUBY_ROOT/lib/ruby/3.4.0/x86_64-darwin22"

export SCARPE_DISPLAY=wv_local
unset BUNDLE_GEMFILE BUNDLE_PATH BUNDLE_BIN_PATH

# Find the user's app
APP_FILE="$(find "$DIR/app" -name "*.rb" -maxdepth 1 | head -1)"
if [ -z "$APP_FILE" ]; then
    osascript -e 'display dialog "No Shoes app found in this bundle!" with title "Hacketyhack — Error" buttons {"OK"} default button "OK" with icon stop'
    exit 1
fi

# Set working directory to the app folder so relative paths work
cd "$DIR/app"

# Launch!
exec "$RUBY_ROOT/bin.real/ruby" "$DIR/boot.rb" "$APP_FILE"
